#!/bin/sh

prog_name=$(basename $0)

sub_help(){
    echo "Usage: $prog_name <subcommand> [options]\n"
    echo "Subcommands:"
    echo "    install   Do bar"
    echo ""
    echo "For help with each subcommand run:"
    echo "$prog_name <subcommand> -h|--help"
    echo ""
}

_install_bundler() {
  source vruby/bin/activate
  gem install bundler
}

sub_install(){

  to=/opt/vruby/share
  version=2.2.0
  platform=$(uname)
  tr_version=20150210
  url_root=http://d6r77u77i8pq3.cloudfront.net/releases

  arg="$1"

  case $arg in
    --to)
      to="$2"
      shift
      ;;
    *)
      cat <<< "WARNING: Unknown option \"$key\"\n\n" 1>&2
  esac

  case $platform in
    (Linux|GNU*)
      ruby_url=$url_root/traveling-ruby-$tr_version-$version-linux-x86_64.tar.gz
      ;;
    (Darwin)
      ruby_url=$url_root/traveling-ruby-$tr_version-$version-osx.tar.gz
      ;;
    (*)
      cat <<< "$platform is an unsupported platform. Please open an issue at https://github.com/joefiorini/vruby with the subject line \"Support for $platform\"." 1>&2
      return 1
      ;;
  esac

  tmp_file=/tmp/$(basename $ruby_url)
  tmp_output=$(dirname $tmp_file)/ruby-$version

  # Save previous directory so we can change back, in the event
  # that $to is passed as a relative path
  previous_dir=$(pwd)

  cd $(dirname $tmp_file)

  if [ ! -f $tmp_file ]; then
    # TODO: Use dictionary of URLs & platforms instead of hardcoding
    cat <<< "Downloading from $ruby_url"
    curl -O $ruby_url
  fi

  mkdir -p $tmp_output
  tar -C $tmp_output -xvf $tmp_file > /dev/null

  sed -i "s/^echo GEM_HOME=.*$//" ruby-$version/bin/ruby_environment

  cd $previous_dir

  cat <<< "Installing to $to"
  mkdir -p $to
  cp -r $tmp_output $to/$version
}

sub_embed() {
  version=2.2.0
  from=/opt/vruby/share
  target_base=$1
  target_dir=$target_base/$version

  activate=$(cat <<-EOF
RUBY_VERSION=$version
RUBY_ENGINE=ruby

export RUBY_ROOT=$target_dir
export GEM_HOME="./.gem/\$RUBY_ENGINE/\$RUBY_VERSION"
export GEM_PATH=\$GEM_HOME

export PATH=\$GEM_HOME/bin:$from/$version/lib/ruby/gems/$version:\$RUBY_ROOT/bin:\$PATH
EOF
)

  mkdir -p $target_dir
  mkdir -p $target_base/bin
  echo "$activate" > $target_base/bin/activate
  stow -d $from -t $target_dir $version

  _install_bundler
}

subcommand=$1
case $subcommand in
    "" | "-h" | "--help")
        sub_help
        ;;
    install)
      shift
      sub_install $@
      ;;
    *)
      sub_embed $@
      ;;
esac
